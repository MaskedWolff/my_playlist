name: Ultimate Playlist Merge (POSIX-safe)

on:
  push:
    paths:
      - 'my_playlist'
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Download External Playlists
        run: |
          echo "⬇️ Downloading external playlists..."
          urls=(
            "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u"
            "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u"
            "https://raw.githubusercontent.com/abid58b/WillowLivePlaylist/refs/heads/main/willowlive.m3u"
            "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u"
            "https://raw.githubusercontent.com/himanshu-temp/m3u/refs/heads/main/sony.m3u"
            "https://raw.githubusercontent.com/drmlive/sliv-live-events/refs/heads/main/sonyliv.m3u"
          )
          files=(
            "external_jstar.m3u"
            "external_fancode.m3u"
            "external_willow.m3u"
            "external_z5.m3u"
            "external_sony.m3u"
            "external_sonyliv.m3u"
          )
          for i in "${!urls[@]}"; do
            echo "Downloading ${files[$i]} ..."
            curl -fsSL "${urls[$i]}" -o "${files[$i]}" || echo "⚠️ Failed to download ${files[$i]}"
          done

      - name: Merge Playlists (Deduplicated)
        run: |
          echo "#EXTM3U" > merged_playlist.m3u
          tempfile=$(mktemp)

          # List all playlists (external + your playlist)
          playlists=(external_jstar.m3u external_fancode.m3u external_willow.m3u external_z5.m3u external_sony.m3u external_sonyliv.m3u my_playlist)

          for p in "${playlists[@]}"; do
            [ -f "$p" ] || continue
            echo "# --- $p ---" >> merged_playlist.m3u
            # Filter out empty lines, append to tempfile
            grep -v '^$' "$p" >> "$tempfile"
          done

          # Deduplicate lines (preserve #EXTM3U and section headers)
          grep -v '^#EXTM3U$' "$tempfile" | sort -u >> merged_playlist.m3u
          rm "$tempfile"
          echo "✅ Merge complete."

      - name: Commit if Updated
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add merged_playlist.m3u
          if ! git diff --cached --quiet; then
            git commit -m "Auto-merge playlists (deduplicated)"
            git pull origin main --rebase || echo "⚠️ Pull failed"
            git push origin main || echo "⚠️ Push failed"
          else
            echo "ℹ️ No changes detected."
