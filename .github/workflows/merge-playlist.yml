name: Ultimate Playlist Merge

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes, adjust as needed

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout Repo
        uses: actions/checkout@v3

      # 2️⃣ Download your playlist
      - name: Download Your Playlist
        run: |
          echo "⬇️ Downloading your playlist..."
          curl -fsSL "https://raw.githubusercontent.com/MaskedWolff/my_playlist/refs/heads/main/my_playlist" -o my_playlist || echo "⚠️ Failed to download your playlist"

      # 3️⃣ Download external playlists
      - name: Download External Playlists
        run: |
          set +e
          echo "⬇️ Downloading external playlists..."
          urls="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u \
                https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u \
                https://raw.githubusercontent.com/abid58b/WillowLivePlaylist/refs/heads/main/willowlive.m3u \
                https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u \
                https://raw.githubusercontent.com/himanshu-temp/m3u/refs/heads/main/sony.m3u \
                https://raw.githubusercontent.com/drmlive/sliv-live-events/refs/heads/main/sonyliv.m3u"
          i=1
          for url in $urls; do
            curl -fsSL "$url" -o "external_$i.m3u" || echo "⚠️ Failed external_$i.m3u"
            i=$((i+1))
          done
          set -e

      # 4️⃣ Merge playlists
      - name: Merge Playlists
        run: |
          set +e
          echo "#EXTM3U" > merged_playlist.m3u
          temp=$(mktemp)
          files="my_playlist external_1.m3u external_2.m3u external_3.m3u external_4.m3u external_5.m3u external_6.m3u"
          for f in $files; do
            [ -f "$f" ] || continue
            echo "# --- $f ---" >> merged_playlist.m3u
            grep -v '^$' "$f" >> "$temp" 2>/dev/null
          done
          # Remove duplicate entries, keep your playlist top
          grep -v '^#EXTM3U$' "$temp" | sort -u >> merged_playlist.m3u
          rm "$temp"
          echo "✅ Merge complete."
          set -e

      # 5️⃣ Commit & push merged playlist
      - name: Commit and Push
        run: |
          set +e
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add merged_playlist.m3u
          if ! git diff --cached --quiet; then
            git commit -m "Auto-merge playlists"
            git pull --rebase origin main || echo "⚠️ Pull failed"
            git push origin main || echo "⚠️ Push failed"
          else
            echo "ℹ️ No changes detected."
          fi
          set -e
